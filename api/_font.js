// api/_font.js
export const nanumGothicBase64 = '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CAAcAAwAHAAkAAgALAAkABwAJAAsACQANAAsACQAPAA0ACQARAA8ACQATAREAAQAAAAQAAwAAAAEABAABAQAEAAEBAAIAAQACAAMAAQAEAAMAAQABAAIAAQACAAIAAQEDAAMAAgACAAEAAwACAAIAAwACAAMAAwADAAMAAQADAAMAAQADAAMAAQADAAMAAgADAAMAAgACAAMAAgACAAIAAQACAAEAAgACAAIAAQEDAAMAAgACAAEABAAFAAEAAgADAAIAAQADAAYABwACAAgABwAHAAgACAAIAAgACQAJAAkACgAKAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACwALAAsACw-gAAIAAEAAAAAAAAAVQADgAUABIAFQATABQAEwATABIAEwASABQAEgASABMAEgAUABQAEgASABMAEgATABMAEwATABQAFQAaABYAGgAWABoAFgAYABgAGgAYABkAEgATABIAEgASABIAEgASABQAEgASABIAEgASABIAEgAUABIAFAAAAAQAAAEAAP/+A/4ABQAFAAAAAAIAAgAIAAIAAgACAAIAAgADAAIAAwACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAg-gAAACWAAAE4gAAABYbmFudW1Hb3RoaWMAAG5hbnVtR290aGljUmVndWxhcgBuAGEAbgB1AG0ARwBvAHQAaABpAGMAAFJlZ3VsYXIAUgBlAGcAdQBsAGEAcgBDb3B5cmlnaHQgKGMpIDIwMDggYnkgTmF2ZXIuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuAE4AYQB2AGUAcgAgAEwAZQB0AHQAZQByAGkAbgBnACAATwBmAGYAZQByAHMAIABUAGgAaQBzACAASgBlAHQARgBvAG4AdABzACAAVAByAHUAZQB0AHkAcABlACAARgBvAG4AdABzACAAVQBuAGQAZQByACAAVABoAGUAIABPAGEAcABhAGMAaABlACAATABpAGMAZQBuAHMAZQAsACAAVgBlAHIAcwBpAG8AbgAgADIALgAwACAAaAB0AHQAcAA6AC8ALwB3AHcAdwAuAGEAcABhAGMAaABlAC4AbwByAGcALwBsAGkAYwBlAG4AcwBlAHMALwBMAEkAQwBFTgBTAEUALQAyAC4AMAAA';

window.jsPDF = window.jspdf.jsPDF;

let logEntries = [];
let editingEntryId = null;

const logTableBody = document.getElementById('log-table-body');
const formTitle = document.getElementById('form-title');
const addModeButtons = document.getElementById('add-mode-buttons');
const editModeButtons = document.getElementById('edit-mode-buttons');
const entryDateInput = document.getElementById('entry-date');
const creationDateInput = document.getElementById('creation-date');
const entryFuelTypeInput = document.getElementById('entry-fuel-type');
const entryFuelPriceInput = document.getElementById('entry-fuel-price');
const entryFuelEfficiencyInput = document.getElementById('entry-fuel-efficiency');

document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    entryDateInput.value = today;
    creationDateInput.value = today;

    document.getElementById('add-entry-btn').addEventListener('click', handleAddEntry);
    document.getElementById('update-entry-btn').addEventListener('click', handleUpdateEntry);
    document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);
    entryDateInput.addEventListener('change', fetchAndSetFuelPrice);
    entryFuelTypeInput.addEventListener('change', () => {
        fetchAndSetFuelPrice();
        updateFuelEfficiency();
    });

    renderLogEntries();
    updateSummary();
    fetchAndSetFuelPrice();
});

async function fetchOilPrice(date) {
  const proxyServerUrl = 'https://opinet-proxy.vercel.app/api/proxy';
  const formattedDate = date.replace(/-/g, '');
  const requestUrl = `${proxyServerUrl}?date=${formattedDate}`;
  try {
    const response = await fetch(requestUrl);
    if (!response.ok) throw new Error(`서버 응답 오류: ${response.status}`);
    const data = await response.json();
    if (data.RESULT && data.RESULT.OIL) {
      return data.RESULT.OIL;
    } else {
      console.error("API 응답에 유가 정보가 없습니다:", data);
      return null;
    }
  } catch (error) {
    console.error('프록시 서버 호출 오류:', error);
    return null;
  }
}

async function fetchAndSetFuelPrice() {
    const date = entryDateInput.value;
    const fuelTypeCode = entryFuelTypeInput.value;
    if (!date) return;
    entryFuelPriceInput.value = "조회 중...";
    const oilPrices = await fetchOilPrice(date);
    if (oilPrices) {
        const priceObject = oilPrices.find(o => o.PRODCD === fuelTypeCode);
        entryFuelPriceInput.value = priceObject ? parseFloat(priceObject.PRICE) : 0;
    } else {
        entryFuelPriceInput.value = 0;
    }
}

function updateFuelEfficiency() {
    const fuelTypeCode = entryFuelTypeInput.value;
    if (fuelTypeCode === 'K015') { // LPG
        entryFuelEfficiencyInput.value = 7;
    } else { // 휘발유 또는 경유
        entryFuelEfficiencyInput.value = 10;
    }
}

async function processEntry(existingEntry = {}) {
    const date = entryDateInput.value;
    const start = document.getElementById('entry-start').value;
    const end = document.getElementById('entry-end').value;
    if (!date || !start || !end) {
        console.error('오류: 일자, 출발지, 도착지를 모두 입력해야 합니다.');
        return null;
    }

    const fuelPrice = parseFloat(entryFuelPriceInput.value) || 0;
    const distance = parseFloat(document.getElementById('entry-distance').value) || 0;

    const fuelTypeSelect = entryFuelTypeInput;
    const fuelTypeCode = fuelTypeSelect.value;
    const fuelTypeName = fuelTypeSelect.options[fuelTypeSelect.selectedIndex].text;
    const fuelEfficiency = parseFloat(entryFuelEfficiencyInput.value) || 1;

    const entryData = {
        id: existingEntry.id || Date.now(),
        date, start, end, distance, fuelPrice, fuelTypeCode, fuelTypeName, fuelEfficiency,
        purpose: document.getElementById('entry-purpose').value,
        toll: parseInt(document.getElementById('entry-toll').value) || 0,
        parking: parseInt(document.getElementById('entry-parking').value) || 0,
        etc: parseInt(document.getElementById('entry-etc').value) || 0,
        remarks: document.getElementById('entry-remarks').value,
    };
    entryData.total = entryData.toll + entryData.parking + entryData.etc;
    return entryData;
}

async function handleAddEntry() {
    const newEntry = await processEntry();
    if (newEntry) {
        logEntries.push(newEntry);
        renderLogEntries();
        updateSummary();
        resetInputForm();
    }
}

async function handleUpdateEntry() {
    const entryIndex = logEntries.findIndex(e => e.id === editingEntryId);
    if (entryIndex === -1) { cancelEdit(); return; }

    const updatedEntry = await processEntry(logEntries[entryIndex]);
    if (updatedEntry) {
        logEntries[entryIndex] = updatedEntry;
        renderLogEntries();
        updateSummary();
        cancelEdit();
    }
}

function renderLogEntries() {
    logTableBody.innerHTML = logEntries.length === 0 ? `<tr><td colspan="14" class="text-gray-500 py-4">운행 기록이 없습니다.</td></tr>` : '';
    logEntries.forEach((entry, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${entry.date}</td><td>${entry.start}</td><td>${entry.end}</td>
            <td class="text-left">${entry.purpose}</td>
            <td>${entry.fuelTypeName}</td>
            <td>${entry.fuelEfficiency.toLocaleString()}</td>
            <td>${entry.distance.toLocaleString()}</td>
            <td>${entry.fuelPrice ? entry.fuelPrice.toLocaleString() : 'N/A'}</td>
            <td>${entry.toll.toLocaleString()}</td><td>${entry.parking.toLocaleString()}</td>
            <td>${entry.etc.toLocaleString()}</td><td class="font-semibold">${entry.total.toLocaleString()}</td>
            <td class="text-left">${entry.remarks || ''}</td>
            <td class="no-print text-center"><div class="flex items-center justify-center space-x-1">
                <button onclick="startEdit(${entry.id})" class="btn btn-sm bg-yellow-500 hover:bg-yellow-600 p-1">수정</button>
                <button onclick="deleteEntry(${entry.id})" class="btn btn-danger btn-sm p-1">삭제</button>
                <button onclick="moveEntry(${index}, 'up')" ${index === 0 ? 'disabled' : ''} class="order-btn disabled:opacity-30">▲</button>
                <button onclick="moveEntry(${index}, 'down')" ${index === logEntries.length - 1 ? 'disabled' : ''} class="order-btn disabled:opacity-30">▼</button>
            </div></td>`;
        logTableBody.appendChild(tr);
    });
}

function startEdit(id) {
    const entry = logEntries.find(e => e.id === id);
    if (!entry) return;
    editingEntryId = id;
    entryDateInput.value = entry.date;
    entryFuelTypeInput.value = entry.fuelTypeCode;
    entryFuelPriceInput.value = entry.fuelPrice;
    entryFuelEfficiencyInput.value = entry.fuelEfficiency;
    document.getElementById('entry-distance').value = entry.distance;
    document.getElementById('entry-purpose').value = entry.purpose;
    document.getElementById('entry-start').value = entry.start;
    document.getElementById('entry-end').value = entry.end;
    document.getElementById('entry-toll').value = entry.toll;
    document.getElementById('entry-parking').value = entry.parking;
    document.getElementById('entry-etc').value = entry.etc;
    document.getElementById('entry-remarks').value = entry.remarks;
    formTitle.textContent = '운행 기록 수정';
    addModeButtons.classList.add('hidden');
    editModeButtons.classList.remove('hidden');
    document.getElementById('entry-form-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function cancelEdit() {
    editingEntryId = null;
    formTitle.textContent = '운행 기록 추가';
    addModeButtons.classList.remove('hidden');
    editModeButtons.classList.add('hidden');
    resetInputForm();
}

function deleteEntry(id) {
    logEntries = logEntries.filter(entry => entry.id !== id);
    renderLogEntries();
    updateSummary();
}

function moveEntry(index, direction) {
    if (direction === 'up' && index > 0) {
        [logEntries[index], logEntries[index - 1]] = [logEntries[index - 1], logEntries[index]];
    } else if (direction === 'down' && index < logEntries.length - 1) {
        [logEntries[index], logEntries[index + 1]] = [logEntries[index + 1], logEntries[index]];
    }
    renderLogEntries();
}

function updateSummary() {
    const depreciationRate = 1.2;
    const totalDistance = logEntries.reduce((sum, entry) => sum + (entry.distance || 0), 0);
    const otherExpenses = logEntries.reduce((sum, entry) => sum + (entry.total || 0), 0);

    const totalFuelCost = logEntries.reduce((sum, entry) => {
        const efficiency = entry.fuelEfficiency || 1;
        if (!entry.distance || !entry.fuelPrice) return sum;
        const cost = (entry.distance / efficiency) * entry.fuelPrice;
        return sum + cost;
    }, 0);

    const grandTotal = (totalFuelCost + otherExpenses) * depreciationRate;

    document.getElementById('total-distance').textContent = totalDistance.toFixed(1).toLocaleString();
    document.getElementById('total-fuel-cost').textContent = Math.round(totalFuelCost).toLocaleString();
    document.getElementById('grand-total').textContent = Math.round(grandTotal).toLocaleString();
}

function resetInputForm() {
    entryDateInput.value = new Date().toISOString().split('T')[0];
    ['entry-start', 'entry-end', 'entry-purpose', 'entry-remarks', 'entry-distance'].forEach(id => document.getElementById(id).value = '');
    ['entry-toll', 'entry-parking', 'entry-etc'].forEach(id => document.getElementById(id).value = '0');
    entryFuelTypeInput.value = 'B027';
    updateFuelEfficiency();
    document.getElementById('entry-start').focus();
    fetchAndSetFuelPrice();
}

function downloadPDF() {
    const pdfGeneratorUrl = 'https://opinet-proxy.vercel.app/api/generate-pdf';
    const logContentElement = document.getElementById('log-content');

    const noPrintElements = logContentElement.querySelectorAll('.no-print');
    noPrintElements.forEach(el => el.style.display = 'none');

    const styles = Array.from(document.styleSheets)
        .map(styleSheet => {
            try {
                if (styleSheet.href) { // 외부 스타일시트는 건너뜁니다 (CORS 방지)
                    return '';
                }
                return Array.from(styleSheet.cssRules)
                    .map(rule => rule.cssText)
                    .join('');
            } catch (e) {
                console.warn('CSS 접근 불가:', styleSheet.href);
                return '';
            }
        }).join('\n');

    const htmlContent = `
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
            <script src="https://cdn.tailwindcss.com"><\/script> 
            <style>${styles}</style>
        </head>
        <body style="font-family: 'Noto Sans KR', sans-serif;">
            ${logContentElement.innerHTML}
        </body>
        </html>
    `;

    noPrintElements.forEach(el => el.style.display = 'flex');

    const pdfButton = document.querySelector('.btn-pdf');
    pdfButton.disabled = true;
    pdfButton.querySelector('span').textContent = '생성 중...';

    fetch(pdfGeneratorUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ htmlContent })
    })
    .then(res => {
        if (!res.ok) {
            return res.json().then(err => { throw new Error(err.details || err.error || '서버에서 PDF를 생성하지 못했습니다.') });
        }
        return res.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;

        const creationDate = document.getElementById('creation-date').value;
        a.download = `차량운행일지_${creationDate || new Date().toISOString().slice(0,10)}.pdf`;

        document.body.appendChild(a);
        a.click();

        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(err => {
        console.error('PDF 다운로드 오류:', err);
        alert(`PDF 다운로드 중 오류가 발생했습니다: ${err.message}`);
    })
    .finally(() => {
        pdfButton.disabled = false;
        pdfButton.querySelector('span').textContent = 'PDF';
    });
}
